<html lang='en'>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Document </title>
    <link rel="stylesheet" href="style.css">
    
</head>

<body id="box">
    <template id="cursor">
        <svg viewBox="0 0 16.3 24.7" class="cursor">
            <path stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M15.6 16.6L.6.6v20.5l4.6-4.5 3.2 7.5 3.4-1.3-3-7.2z" />
        </svg>
    </template>

    <script> 

        
        const main = async () => {

            const connectToServer = async () => {
                const ws = new WebSocket('ws://localhost:7071')
                return new Promise( (resolve, reject) => {
                    const timer = setInterval( () => {
                        const OPEN = 1 // The connection is open and ready to communicate.
                        if (ws.readyState===OPEN) {
                            clearInterval(timer);
                            resolve(ws)
                        }
                    }, 10);
                })
            }

            const getOrCreateCursorFor = messageBody => {
                const { sender, color, x, y } = messageBody
                const existing = document.querySelector(`[data-sender='${sender}']`)
                if (existing) {
                    return existing
                }

                const template = document.getElementById('cursor');
                const cursor = template.content.firstElementChild.cloneNode(true);
                const svgPath = cursor.getElementsByTagName('path')[0]

                cursor.setAttribute("data-sender", sender);
                svgPath.setAttribute("fill", `hsl(${messageBody.color}, 50%, 50%)`);
                document.body.appendChild(cursor);

                return cursor
            }

            // run 

            const ws = await connectToServer();

            ws.onmessage = (webSocketMessage) => {
                console.log(`Recebido mensagem do servidor`)
                const messageBody = JSON.parse(webSocketMessage.data)
                const { sender, color, x, y } = messageBody
                console.table(messageBody)
                const cursor = getOrCreateCursorFor(messageBody)
                cursor.style.transform = `translate(${x}px, ${y}px)`;
            }  

            document.body.onmousemove = event => {
                const messageBody = {
                    x: event.clientX,
                    y: event.clientY,
                }
                ws.send(JSON.stringify(messageBody));
            }


        }

        console.log('hello world juca!')
        main();
    </script>

</body>
</html> 